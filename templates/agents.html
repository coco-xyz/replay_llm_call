{% extends "base.html" %}

{% block page_title %}Agents - LLM Replay System{% endblock %}

{% block extra_css %}
<style>
    .page-title {
        font-size: 2rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 0.5rem;
    }

    .page-subtitle {
        color: var(--text-secondary);
        font-size: 1rem;
    }

    .card {
        background: var(--card-background);
        border: 1px solid var(--border-color);
        border-radius: 0.75rem;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        transition: all 0.2s ease;
    }

    .card:hover {
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .btn-primary {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
        font-weight: 500;
        padding: 0.625rem 1.25rem;
        border-radius: 0.5rem;
        transition: all 0.2s ease;
    }

    .btn-primary:hover {
        background-color: var(--primary-hover);
        border-color: var(--primary-hover);
        transform: translateY(-1px);
    }

    .btn-outline-primary {
        color: var(--primary-color);
        border-color: var(--primary-color);
        font-weight: 500;
        border-radius: 0.5rem;
    }

    .btn-outline-primary:hover {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
    }

    .badge {
        font-weight: 500;
        padding: 0.375rem 0.75rem;
        border-radius: 0.375rem;
        font-size: 0.75rem;
    }

    .badge.bg-success {
        background-color: var(--success-color) !important;
    }

    .badge.bg-secondary {
        background-color: var(--secondary-color) !important;
    }

    .table-container {
        background: var(--card-background);
        border-radius: 0.75rem;
        overflow: hidden;
        border: 1px solid var(--border-color);
    }

    .table th {
        background-color: #f8fafc;
        border-bottom: 1px solid var(--border-color);
        font-weight: 600;
        color: var(--text-primary);
        padding: 1rem;
        font-size: 0.875rem;
    }

    .table td {
        padding: 1rem;
        border-bottom: 1px solid #f1f5f9;
        vertical-align: middle;
    }

    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        color: var(--text-secondary);
    }

    .empty-state .empty-icon {
        width: 4rem;
        height: 4rem;
        background-color: #f1f5f9;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1.5rem;
    }

    .empty-state .empty-icon i {
        font-size: 1.5rem;
        color: var(--text-muted);
    }

    .empty-state h3 {
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 0.5rem;
    }

    .empty-state p {
        color: var(--text-secondary);
        margin-bottom: 1.5rem;
    }

    .loading-state {
        text-align: center;
        padding: 3rem 2rem;
    }

    .loading-spinner {
        display: inline-flex;
        align-items: center;
        gap: 0.75rem;
        color: var(--primary-color);
    }

    .loading-spinner .spinner-border {
        width: 1.25rem;
        height: 1.25rem;
    }

    .form-text {
        color: var(--text-secondary);
    }

    .modal-content {
        border-radius: 0.75rem;
        border: 1px solid var(--border-color);
    }

    .modal-header,
    .modal-footer {
        border-color: var(--border-color);
    }

    @media (max-width: 768px) {
        .page-title {
            font-size: 1.5rem;
        }

        .card-body {
            padding: 1rem;
        }

        .btn-group {
            flex-direction: column;
            gap: 0.5rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center mb-4">
        <div class="mb-3 mb-lg-0">
            <h1 class="page-title">
                <i class="fas fa-user-astronaut me-3"></i>Agents
            </h1>
            <p class="page-subtitle mb-0">Manage reusable model configurations and ownership for your test cases</p>
        </div>
        <div class="d-flex align-items-center gap-2">
            <button class="btn btn-outline-primary" id="refreshAgentsBtn">
                <i class="fas fa-refresh me-2"></i>Refresh
            </button>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createAgentModal"
                id="createAgentBtn">
                <i class="fas fa-plus me-2"></i>Create Agent
            </button>
        </div>
    </div>

    <div id="agentHelp" class="alert alert-info d-none" role="alert">
        <i class="fas fa-circle-info me-2"></i>
        <span>Agents capture default model parameters for reuse during regression runs. Create at least one agent before
            adding new test cases.</span>
    </div>

    <div class="table-container">
        <table class="table table-hover mb-0" id="agentsTable">
            <thead>
                <tr>
                    <th style="width: 16%">Agent</th>
                    <th style="width: 36%">Description</th>
                    <th style="width: 22%">Defaults</th>
                    <th style="width: 16%">Created</th>
                    <th style="width: 10%" class="text-end">Actions</th>
                </tr>
            </thead>
            <tbody id="agentsList">
                <!-- Agents will be rendered here -->
            </tbody>
        </table>
    </div>

    <div id="loadingSpinner" class="loading-state d-none">
        <div class="loading-spinner">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <span>Loading agents...</span>
        </div>
    </div>

    <div id="emptyState" class="empty-state d-none">
        <div class="empty-icon">
            <i class="fas fa-users-slash"></i>
        </div>
        <h3>No agents configured</h3>
        <p>Agents keep your regression defaults consistent. Create your first agent to get started.</p>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createAgentModal">
            <i class="fas fa-plus me-2"></i>Create Agent
        </button>
    </div>
</div>

<!-- Create Agent Modal -->
<div class="modal fade" id="createAgentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create Agent</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="createAgentAlert"></div>
                <form id="createAgentForm">
                    <div class="mb-3">
                        <label for="createAgentName" class="form-label">Name *</label>
                        <input type="text" class="form-control" id="createAgentName" required>
                    </div>
                    <div class="mb-3">
                        <label for="createAgentDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="createAgentDescription" rows="3"
                            placeholder="Describe the scenarios this agent covers"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="createAgentModelName" class="form-label">Default Model Name *</label>
                        <div class="position-relative">
                            <input type="text" class="form-control" id="createAgentModelName" placeholder="e.g. gpt-4o"
                                required autocomplete="off">
                            <div class="model-history-dropdown" id="createAgentModelNameDropdown"></div>
                        </div>
                        <div class="form-text">Used as the baseline model during regression runs. You can override it
                            per run.</div>
                    </div>
                    <div class="mb-3">
                        <label for="createAgentSystemPrompt" class="form-label">Default System Prompt *</label>
                        <textarea class="form-control" id="createAgentSystemPrompt" rows="4"
                            placeholder="Provide the default system instructions" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="createAgentModelSettings" class="form-label">Default Model Settings (JSON)</label>
                        <textarea class="form-control" id="createAgentModelSettings" rows="5"
                            placeholder='{"temperature": 0.2, "max_tokens": 4096}'></textarea>
                        <div class="form-text">Optional JSON blob applied to all regression executions. Leave blank to
                            use per test case settings.</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmCreateAgent">
                    <i class="fas fa-save me-2"></i>Create Agent
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Agent Modal -->
<div class="modal fade" id="editAgentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Agent</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="editAgentAlert"></div>
                <form id="editAgentForm">
                    <input type="hidden" id="editAgentId">
                    <div class="mb-3">
                        <label for="editAgentName" class="form-label">Name *</label>
                        <input type="text" class="form-control" id="editAgentName" required>
                    </div>
                    <div class="mb-3">
                        <label for="editAgentDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="editAgentDescription" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="editAgentModelName" class="form-label">Default Model Name *</label>
                        <div class="position-relative">
                            <input type="text" class="form-control" id="editAgentModelName" required autocomplete="off">
                            <div class="model-history-dropdown" id="editAgentModelNameDropdown"></div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editAgentSystemPrompt" class="form-label">Default System Prompt *</label>
                        <textarea class="form-control" id="editAgentSystemPrompt" rows="4" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="editAgentModelSettings" class="form-label">Default Model Settings (JSON)</label>
                        <textarea class="form-control" id="editAgentModelSettings" rows="5"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmUpdateAgent">
                    <i class="fas fa-save me-2"></i>Save Changes
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="/static/js/model-history.js?v={{ static_asset_version }}"></script>
<script src="/static/js/hover-tooltips.js?v={{ static_asset_version }}"></script>
<script src="/static/js/agents.js?v={{ static_asset_version }}"></script>
{% endblock %}
