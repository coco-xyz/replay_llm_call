{% extends "base.html" %}

{% block page_title %}Test Case Details - LLM Replay System{% endblock %}

{% block extra_css %}
<style>
    /* Page Header */
    .page-header {
        margin-bottom: 2rem;
    }

    .page-title {
        font-size: 2rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 0.5rem;
    }

    .page-subtitle {
        color: var(--text-secondary);
        font-size: 1rem;
    }

    /* Action buttons in header */
    .page-header #actionButtons {
        margin-top: 0.5rem;
    }

    /* Card Styles */
    .card {
        background: var(--card-background);
        border: 1px solid var(--border-color);
        border-radius: 0.75rem;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        transition: all 0.2s ease;
    }

    .card:hover {
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .card-header {
        background-color: #f8fafc;
        border-bottom: 1px solid var(--border-color);
        font-weight: 600;
        color: var(--text-primary);
        padding: 1rem 1.5rem;
        border-radius: 0.75rem 0.75rem 0 0 !important;
    }

    .card-body {
        padding: 1.5rem;
    }

    /* Button Styles */
    .btn-primary {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
        font-weight: 500;
        padding: 0.625rem 1.25rem;
        border-radius: 0.5rem;
        transition: all 0.2s ease;
    }

    .btn-primary:hover {
        background-color: var(--primary-hover);
        border-color: var(--primary-hover);
        transform: translateY(-1px);
    }

    .btn-outline-secondary {
        color: var(--text-secondary);
        border-color: var(--border-color);
        font-weight: 500;
        border-radius: 0.5rem;
        transition: all 0.2s ease;
    }

    .btn-outline-secondary:hover {
        background-color: var(--text-secondary);
        border-color: var(--text-secondary);
        transform: translateY(-1px);
    }

    .btn-outline-primary {
        color: var(--primary-color);
        border-color: var(--primary-color);
        font-weight: 500;
        border-radius: 0.5rem;
        transition: all 0.2s ease;
    }

    .btn-outline-primary:hover {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
        color: white;
        transform: translateY(-1px);
    }

    .btn-success {
        background-color: var(--success-color);
        border-color: var(--success-color);
        font-weight: 500;
        border-radius: 0.5rem;
    }

    .btn-outline-danger {
        color: var(--danger-color);
        border-color: var(--danger-color);
        font-weight: 500;
        border-radius: 0.5rem;
    }

    /* Table Styles */
    .info-table {
        margin-bottom: 0;
    }

    .info-table td {
        padding: 0.75rem 1rem;
        border-bottom: 1px solid #f1f5f9;
        vertical-align: middle;
    }

    .info-table td:first-child {
        font-weight: 600;
        color: var(--text-secondary);
        width: 150px;
        background-color: #f8fafc;
    }

    .info-table tr:last-child td {
        border-bottom: none;
    }

    /* Code Block Styles */
    .code-block {
        background-color: #f1f5f9;
        border: 1px solid var(--border-color);
        border-radius: 0.5rem;
        padding: 1rem;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 0.875rem;
        line-height: 1.5;
        max-height: 400px;
        overflow-y: auto;
        color: var(--text-primary);
        white-space: pre-wrap;
        word-wrap: break-word;
    }

    /* Loading State */
    .loading-state {
        text-align: center;
        padding: 3rem 2rem;
    }

    .loading-spinner {
        display: inline-flex;
        align-items: center;
        gap: 0.75rem;
        color: var(--primary-color);
    }

    .loading-spinner .spinner-border {
        width: 1.25rem;
        height: 1.25rem;
    }

    /* Error Message */
    .error-message {
        background-color: #fef2f2;
        border: 1px solid #fecaca;
        color: var(--danger-color);
        padding: 1rem;
        border-radius: 0.5rem;
        margin: 1rem 0;
    }

    /* Responsive Improvements */
    @media (max-width: 768px) {
        .page-title {
            font-size: 1.5rem;
        }

        .card-body {
            padding: 1rem;
        }

        .info-table td:first-child {
            width: 120px;
            font-size: 0.875rem;
        }

        .btn-group {
            flex-direction: column;
            gap: 0.5rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Header with Action Buttons -->
    <div class="page-header d-flex justify-content-between align-items-start">
        <div>
            <h1 class="page-title">
                <i class="fas fa-file-code me-3"></i>Test Case Details
            </h1>
            <p class="page-subtitle">Detailed view of test case configuration</p>
        </div>
        <div id="actionButtons" class="d-none">
            <div class="d-flex gap-2">
                <button type="button" class="btn btn-outline-primary" onclick="editTestCase()">
                    <i class="fas fa-edit me-2"></i>Edit Test Case
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="viewTestLogs()">
                    <i class="fas fa-history me-2"></i>View Test Logs
                </button>
                <button type="button" class="btn btn-success" onclick="executeTest()">
                    <i class="fas fa-play me-2"></i>Execute Test
                </button>
                <button type="button" class="btn btn-outline-danger" onclick="deleteTestCase()">
                    <i class="fas fa-trash me-2"></i>Delete Test Case
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="loading-state">
        <div class="loading-spinner">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <span>Loading test case details...</span>
        </div>
    </div>

    <!-- Error Message -->
    <div id="errorMessage" class="error-message d-none">
        <i class="fas fa-exclamation-triangle me-2"></i>
        <span id="errorText"></span>
    </div>

    <!-- Test Case Details Content -->
    <div id="testCaseDetailsContent" class="d-none">
        <!-- Content will be loaded here -->
    </div>
</div>

<!-- Edit Test Case Modal -->
<div class="modal fade" id="editTestCaseModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Test Case</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editTestCaseForm">
                    <input type="hidden" id="editTestCaseId">
                    <div class="mb-3">
                        <label for="editTestCaseName" class="form-label">Name *</label>
                        <input type="text" class="form-control" id="editTestCaseName" required>
                    </div>
                    <div class="mb-3">
                        <label for="editTestCaseDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="editTestCaseDescription" rows="4"
                            placeholder="Enter a description for this test case..."></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="editTestCaseAgent" class="form-label">Agent *</label>
                        <select class="form-select" id="editTestCaseAgent" required>
                            <option value="">Select an agent...</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editResponseExample" class="form-label">Response Example</label>
                        <textarea class="form-control" id="editResponseExample" rows="4"
                            placeholder="Update the example LLM response..."></textarea>
                        <div class="form-text">Used for similarity scoring when future logs are generated.</div>
                    </div>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Note:</strong> Update the agent to hand off this test case to a different model
                        configuration and adjust the response example as needed. Other parsed properties (system prompt,
                        user message, etc.) remain read-only here.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateTestCase()">
                    <i class="fas fa-save me-2"></i>Update Test Case
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    const caseId = '{{ case_id }}';
    let currentTestCase = null;

    document.addEventListener('DOMContentLoaded', function () {
        loadTestCaseDetails();
        loadAgents(); // Load agents for edit functionality
    });

    async function loadTestCaseDetails() {
        try {
            const response = await fetch(`/v1/api/test-cases/${caseId}`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            currentTestCase = await response.json();
            displayTestCaseDetails(currentTestCase);

            // Show action buttons and hide loading
            document.getElementById('actionButtons').classList.remove('d-none');
            document.getElementById('loadingSpinner').classList.add('d-none');
            document.getElementById('testCaseDetailsContent').classList.remove('d-none');

        } catch (error) {
            console.error('Error loading test case details:', error);
            document.getElementById('errorText').textContent = 'Failed to load test case details: ' + error.message;
            document.getElementById('errorMessage').classList.remove('d-none');
            document.getElementById('loadingSpinner').classList.add('d-none');
        }
    }

    // Helper function to format middle messages
    function formatMiddleMessages(messages) {
        if (!messages || messages.length === 0) {
            return '<div class="text-muted">No middle messages</div>';
        }

        return messages.map((message, index) => {
            const role = message.role || 'unknown';
            const content = message.content || '';
            const toolCalls = message.tool_calls || [];
            const roleColor = {
                'user': 'text-primary',
                'assistant': 'text-success',
                'tool': 'text-warning',
                'system': 'text-info'
            }[role] || 'text-secondary';

            // Format tool calls if present
            const formatToolCalls = (calls) => {
                if (!calls || calls.length === 0) return '';

                return calls.map((call, callIndex) => {
                    const toolId = call.id || 'unknown';
                    const toolName = call.function?.name || 'unknown';
                    const toolArgs = call.function?.arguments || '';

                    // Try to format arguments as JSON for better readability
                    let formattedArgs = toolArgs;
                    try {
                        if (typeof toolArgs === 'string') {
                            const parsed = JSON.parse(toolArgs);
                            formattedArgs = JSON.stringify(parsed, null, 2);
                        } else if (typeof toolArgs === 'object') {
                            formattedArgs = JSON.stringify(toolArgs, null, 2);
                        }
                    } catch (e) {
                        // Keep original format if JSON parsing fails
                        formattedArgs = String(toolArgs);
                    }

                    return `
                                <div class="mt-2 p-2 bg-warning bg-opacity-10 border border-warning border-opacity-25 rounded">
                                    <div class="d-flex align-items-center mb-1">
                                        <i class="fas fa-tools text-warning me-2"></i>
                                        <strong class="text-warning">Tool Call #${callIndex + 1}</strong>
                                    </div>
                                    <div class="small">
                                        <div><strong>Name:</strong> <code>${escapeHtml(toolName)}</code></div>
                                        <div><strong>ID:</strong> <code>${escapeHtml(toolId)}</code></div>
                                        <div><strong>Arguments:</strong></div>
                                        <pre class="bg-light p-2 rounded mt-1 mb-0" style="font-size: 0.8em; max-height: 100px; overflow-y: auto;">${escapeHtml(formattedArgs)}</pre>
                                    </div>
                                </div>
                            `;
                }).join('');
            };

            return `
                        <div class="mb-2 border-start border-3 ps-2" style="border-color: var(--bs-${role === 'user' ? 'primary' : role === 'assistant' ? 'success' : role === 'tool' ? 'warning' : 'secondary'}) !important;">
                            <div class="d-flex align-items-center mb-1">
                                <span class="badge bg-secondary me-2">#${index + 1}</span>
                                <strong class="${roleColor}">${escapeHtml(role.toUpperCase())}</strong>
                                ${toolCalls.length > 0 ? `<span class="badge bg-warning ms-2">${toolCalls.length} tool call${toolCalls.length > 1 ? 's' : ''}</span>` : ''}
                            </div>
                            ${content ? `<pre class="bg-light p-2 rounded mb-0" style="font-size: 0.85em; max-height: 150px; overflow-y: auto;">${escapeHtml(content)}</pre>` : ''}
                            ${formatToolCalls(toolCalls)}
                        </div>
                    `;
        }).join('');
    }

    function displayTestCaseDetails(testCase) {
        const agentName = testCase.agent ? testCase.agent.name : null;
        const agentId = testCase.agent_id || '';
        const agentDescription = testCase.agent && testCase.agent.description ? testCase.agent.description : '';
        const agentDescriptionHtml = agentDescription
            ? `<small class="text-muted text-truncate d-block" style="max-width: 320px;" title="${escapeHtml(agentDescription)}">${escapeHtml(agentDescription)}</small>`
            : '';
        const agentBadge = agentName && agentId
            ? `<div class="d-flex flex-column align-items-start">
                    <a href="/agents/${escapeHtml(agentId)}" class="badge bg-primary text-decoration-none" target="_blank">${escapeHtml(agentName)}</a>
                    ${agentDescriptionHtml}
                </div>`
            : '<span class="text-muted">Unknown agent</span>';

        const detailsHtml = `
                    <div class="row">
                        <!-- Left Column -->
                        <div class="col-md-6">
                            <!-- Basic Information -->
                            <div class="card mb-4">
                                <div class="card-header">
                                    <i class="fas fa-info-circle me-2"></i>Basic Information
                                </div>
                                <div class="card-body p-0">
                                    <table class="table info-table mb-0">
                                        <tr>
                                            <td>Test Case ID:</td>
                                            <td><code>${escapeHtml(testCase.id)}</code></td>
                                        </tr>
                                        <tr>
                                            <td>Name:</td>
                                            <td><strong>${escapeHtml(testCase.name)}</strong></td>
                                        </tr>
                                        <tr>
                                            <td>Description:</td>
                                            <td>${escapeHtml(testCase.description || 'No description provided')}</td>
                                        </tr>
                                        <tr>
                                            <td>Agent:</td>
                                            <td>${agentBadge}</td>
                                        </tr>
                                        <tr>
                                            <td>Created At:</td>
                                            <td>${formatDate(testCase.created_at)}</td>
                                        </tr>
                                        <tr>
                                            <td>Updated At:</td>
                                            <td>${formatDate(testCase.updated_at)}</td>
                                        </tr>
                                        <tr>
                                            <td>Model Name:</td>
                                            <td><code>${escapeHtml(testCase.model_name)}</code></td>
                                        </tr>
                                        <tr>
                                            <td>Model Settings:</td>
                                            <td>${testCase.model_settings !== null && testCase.model_settings !== undefined ? `<pre class=\"bg-light p-2 rounded\"><code>${escapeHtml(JSON.stringify(testCase.model_settings, null, 2))}</code></pre>` : '<span class=\"text-muted\">Not specified</span>'}</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>

                            <!-- System Prompt (moved under Basic Information) -->
                            <div class="card mb-4">
                                <div class="card-header">
                                    <i class="fas fa-terminal me-2"></i>System Prompt
                                </div>
                                <div class="card-body">
                                    <div class="code-block">${escapeHtml(testCase.system_prompt || 'No system prompt provided')}</div>
                                </div>
                            </div>

                            <!-- Tools Configuration (moved under System Prompt) -->
                            ${testCase.tools && testCase.tools.length > 0 ? `
                                <div class="card mb-4">
                                    <div class="card-header">
                                        <i class="fas fa-wrench me-2"></i>Tools Configuration
                                    </div>
                                    <div class="card-body">
                                        <div class="accordion" id="testCaseToolsAccordion">
                                            ${testCase.tools.map((tool, index) => `
                                                <div class="accordion-item">
                                                    <h2 class="accordion-header" id="testCaseHeading${index}">
                                                        <button class="accordion-button collapsed" type="button"
                                                                data-bs-toggle="collapse" data-bs-target="#testCaseCollapse${index}"
                                                                aria-expanded="false" aria-controls="testCaseCollapse${index}">
                                                            <i class="fas fa-wrench me-2"></i>
                                                            <strong>${escapeHtml(tool.function?.name || 'Unknown Tool')}</strong>
                                                        </button>
                                                    </h2>
                                                    <div id="testCaseCollapse${index}" class="accordion-collapse collapse"
                                                         aria-labelledby="testCaseHeading${index}" data-bs-parent="#testCaseToolsAccordion">
                                                        <div class="accordion-body">
                                                            <div class="code-block" style="font-size: 0.85em;">${escapeHtml(JSON.stringify(tool, null, 2))}</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>
                            ` : `
                                <div class="card mb-4">
                                    <div class="card-header">
                                        <i class="fas fa-wrench me-2"></i>Tools
                                    </div>
                                    <div class="card-body">
                                        <p class="text-muted mb-0">No tools configured</p>
                                    </div>
                                </div>
                            `}
                        </div>

                        <!-- Right Column -->
                        <div class="col-md-6">
                            <!-- User Message -->
                            <div class="card mb-4">
                                <div class="card-header">
                                    <i class="fas fa-comment me-2"></i>User Message
                                </div>
                                <div class="card-body">
                                    <div class="code-block">${escapeHtml(testCase.last_user_message || 'No user message provided')}</div>
                                </div>
                            </div>

                            <!-- Response Example -->
                            <div class="card mb-4">
                                <div class="card-header">
                                    <i class="fas fa-reply me-2"></i>Response Example
                                </div>
                                <div class="card-body">
                                    ${testCase.response_example
                ? `<div class=\"code-block\">${escapeHtml(testCase.response_example)}</div>`
                : '<p class=\"text-muted mb-0\">No response example recorded</p>'}
                                </div>
                            </div>

                            <!-- Middle Messages (moved below Response Example) -->
                            <div class="card mb-4">
                                <div class="card-header">
                                    <i class="fas fa-comments me-2"></i>Middle Messages
                                </div>
                                <div class="card-body">
                                    <div style="max-height: 400px; overflow-y: auto;">
                                        ${formatMiddleMessages(testCase.middle_messages)}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

        document.getElementById('testCaseDetailsContent').innerHTML = detailsHtml;
    }

    function escapeHtml(text) {
        if (text === null || text === undefined) return '';
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.toString().replace(/[&<>"']/g, function (m) { return map[m]; });
    }

    function formatDate(dateString) {
        if (!dateString) return 'N/A';
        const date = new Date(dateString);
        return date.toLocaleString('en-US', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
    }

    async function executeTest() {
        if (!currentTestCase) return;

        try {
            // Redirect to test execution page with this test case
            window.open(`/test-execution?testCaseId=${currentTestCase.id}`, '_blank');
        } catch (error) {
            console.error('Error executing test:', error);
            alert('Error executing test: ' + error.message);
        }
    }

    function viewTestLogs() {
        if (currentTestCase) {
            window.open(`/test-logs?testCaseId=${currentTestCase.id}`, '_blank');
        } else {
            window.open('/test-logs', '_blank');
        }
    }

    async function editTestCase() {
        if (!currentTestCase) return;

        try {
            // Load agents if not already loaded
            if (!window.agents || window.agents.length === 0) {
                await loadAgents();
            }

            // Populate edit form
            document.getElementById('editTestCaseId').value = currentTestCase.id;
            document.getElementById('editTestCaseName').value = currentTestCase.name;
            document.getElementById('editTestCaseDescription').value = currentTestCase.description || '';
            document.getElementById('editResponseExample').value = currentTestCase.response_example || '';

            // Populate agent select
            const editAgentSelect = document.getElementById('editTestCaseAgent');
            editAgentSelect.innerHTML = '<option value="">Select an agent...</option>';
            window.agents.forEach(agent => {
                const option = document.createElement('option');
                option.value = agent.id;
                option.textContent = agent.name;
                if (agent.id === currentTestCase.agent_id) {
                    option.selected = true;
                }
                editAgentSelect.appendChild(option);
            });

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('editTestCaseModal'));
            modal.show();

        } catch (error) {
            console.error('Error loading edit form:', error);
            alert('Error loading edit form: ' + error.message);
        }
    }

    async function deleteTestCase() {
        if (!currentTestCase) return;

        if (!confirm(`Are you sure you want to delete the test case "${currentTestCase.name}"? This action cannot be undone.`)) {
            return;
        }

        try {
            const response = await fetch(`/v1/api/test-cases/${currentTestCase.id}`, {
                method: 'DELETE'
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            alert('Test case deleted successfully!');
            // Redirect back to test cases page
            window.location.href = '/test-cases';

        } catch (error) {
            console.error('Error deleting test case:', error);
            alert('Error deleting test case: ' + error.message);
        }
    }

    // Global variable to store agents
    window.agents = [];

    async function loadAgents() {
        try {
            const response = await fetch('/v1/api/agents');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            window.agents = await response.json();
        } catch (error) {
            console.error('Error loading agents:', error);
            window.agents = [];
        }
    }

    async function updateTestCase() {
        const testCaseId = document.getElementById('editTestCaseId').value;
        const name = document.getElementById('editTestCaseName').value.trim();
        const description = document.getElementById('editTestCaseDescription').value.trim();
        const agentId = document.getElementById('editTestCaseAgent').value;
        const responseExample = document.getElementById('editResponseExample').value.trim();

        if (!name || !agentId) {
            showAlert('Please provide a name and agent for the test case', 'warning');
            return;
        }

        try {
            const response = await fetch(`/v1/api/test-cases/${testCaseId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    name: name,
                    description: description || null,
                    agent_id: agentId || null,
                    response_example: responseExample || null
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || `HTTP error! status: ${response.status}`);
            }

            showAlert('Test case updated successfully!', 'success');

            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('editTestCaseModal'));
            modal.hide();

            // Reload test case details
            loadTestCaseDetails();

        } catch (error) {
            console.error('Error updating test case:', error);
            showAlert('Error updating test case: ' + error.message, 'danger');
        }
    }

    function showAlert(message, type = 'info') {
        // Create alert element
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;

        // Insert at the top of the container
        const container = document.querySelector('.container');
        container.insertBefore(alertDiv, container.firstChild);

        // Auto-dismiss after 5 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }
</script>
{% endblock %}