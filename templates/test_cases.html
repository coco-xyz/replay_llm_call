{% extends "base.html" %}

{% block page_title %}Test Cases - LLM Replay System{% endblock %}

{% block extra_css %}
<style>
    /* Page Header */
    .page-header {
        margin-bottom: 2rem;
    }

    .page-title {
        font-size: 2rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 0.5rem;
    }

    .page-subtitle {
        color: var(--text-secondary);
        font-size: 1rem;
    }

    /* Card Styles */
    .card {
        background: var(--card-background);
        border: 1px solid var(--border-color);
        border-radius: 0.75rem;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        transition: all 0.2s ease;
    }

    .card:hover {
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    /* Button Styles */
    .btn-primary {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
        font-weight: 500;
        padding: 0.625rem 1.25rem;
        border-radius: 0.5rem;
        transition: all 0.2s ease;
    }

    .btn-primary:hover {
        background-color: var(--primary-hover);
        border-color: var(--primary-hover);
        transform: translateY(-1px);
    }

    .btn-outline-primary {
        color: var(--primary-color);
        border-color: var(--primary-color);
        font-weight: 500;
        border-radius: 0.5rem;
    }

    .btn-outline-primary:hover {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
    }

    /* Search Input */
    .search-container {
        position: relative;
        max-width: 400px;
    }

    .search-container .form-control {
        padding-left: 2.75rem;
        border-radius: 0.5rem;
        border: 1px solid var(--border-color);
        background-color: var(--card-background);
        transition: all 0.2s ease;
    }

    .search-container .form-control:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .search-container .search-icon {
        position: absolute;
        left: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-muted);
        z-index: 1;
        pointer-events: none;
    }

    .filter-search-group {
        position: relative;
        width: 220px;
        flex: 0 0 auto;
    }

    .filter-search-group.w-100 {
        width: 100% !important;
    }

    .filter-search-results {
        position: absolute;
        top: calc(100% + 0.25rem);
        left: 0;
        right: 0;
        z-index: 30;
        background: var(--card-background);
        border: 1px solid var(--border-color);
        border-radius: 0.5rem;
        box-shadow: 0 10px 20px -12px rgba(15, 23, 42, 0.45);
        max-height: 220px;
        overflow-y: auto;
    }

    .filter-search-results button {
        width: 100%;
        text-align: left;
        border: none;
        background: transparent;
        padding: 0.5rem 0.75rem;
        font-size: 0.8125rem;
        display: flex;
        flex-direction: column;
        gap: 0.15rem;
        color: var(--text-primary);
    }

    .filter-search-results button:hover,
    .filter-search-results button:focus {
        background: #f8fafc;
        outline: none;
    }

    .filter-search-results .result-secondary {
        font-size: 0.7rem;
        color: var(--text-secondary);
    }

    .filter-search-empty {
        padding: 0.75rem;
        font-size: 0.8rem;
        color: var(--text-secondary);
    }

    /* Table Styles */
    .table-container {
        background: var(--card-background);
        border-radius: 0.75rem;
        overflow: hidden;
        border: 1px solid var(--border-color);
    }

    .table {
        margin-bottom: 0;
    }

    .table th {
        background-color: #f8fafc;
        border-bottom: 1px solid var(--border-color);
        font-weight: 600;
        color: var(--text-primary);
        padding: 1rem;
        font-size: 0.875rem;
    }

    .table td {
        padding: 1rem;
        border-bottom: 1px solid #f1f5f9;
        vertical-align: middle;
    }

    .table tbody tr {
        transition: background-color 0.2s ease;
    }

    .table tbody tr:hover {
        background-color: #f8fafc;
    }

    .table tbody tr:last-child td {
        border-bottom: none;
    }

    /* Badge Styles */
    .badge {
        font-weight: 500;
        padding: 0.375rem 0.75rem;
        border-radius: 0.375rem;
        font-size: 0.75rem;
    }

    .badge.bg-primary {
        background-color: var(--primary-color) !important;
    }

    .badge.bg-info {
        background-color: var(--success-color) !important;
    }

    /* Action Buttons */
    .btn-group .btn {
        border-radius: 0.375rem !important;
        margin-right: 0.25rem;
        padding: 0.375rem 0.75rem;
        font-size: 0.875rem;
        transition: all 0.2s ease;
    }

    .btn-group .btn:last-child {
        margin-right: 0;
    }

    .btn-outline-primary:hover,
    .btn-outline-secondary:hover,
    .btn-outline-success:hover,
    .btn-outline-danger:hover {
        transform: translateY(-1px);
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        color: var(--text-secondary);
    }

    .empty-state .empty-icon {
        width: 4rem;
        height: 4rem;
        background-color: #f1f5f9;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1.5rem;
    }

    .empty-state .empty-icon i {
        font-size: 1.5rem;
        color: var(--text-muted);
    }

    .empty-state h3 {
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 0.5rem;
    }

    .empty-state p {
        color: var(--text-secondary);
        margin-bottom: 1.5rem;
    }

    /* Loading State */
    .loading-state {
        text-align: center;
        padding: 3rem 2rem;
    }

    .loading-spinner {
        display: inline-flex;
        align-items: center;
        gap: 0.75rem;
        color: var(--primary-color);
    }

    .loading-spinner .spinner-border {
        width: 1.25rem;
        height: 1.25rem;
    }

    /* Modal Enhancements */
    .modal-content {
        border-radius: 0.75rem;
        border: 1px solid var(--border-color);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    }

    .modal-header {
        border-bottom: 1px solid var(--border-color);
        padding: 1.5rem;
    }

    .modal-title {
        font-weight: 600;
        color: var(--text-primary);
    }

    .modal-body {
        padding: 1.5rem;
    }

    .modal-footer {
        border-top: 1px solid var(--border-color);
        padding: 1.5rem;
    }

    /* Form Enhancements */
    .form-label {
        font-weight: 500;
        color: var(--text-primary);
        margin-bottom: 0.5rem;
    }

    .form-control,
    .form-select {
        border-radius: 0.5rem;
        border: 1px solid var(--border-color);
        padding: 0.625rem 0.75rem;
        transition: all 0.2s ease;
    }

    .form-control:focus,
    .form-select:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .form-text {
        color: var(--text-muted);
        font-size: 0.875rem;
    }

    /* Responsive Improvements */
    @media (max-width: 768px) {
        .page-title {
            font-size: 1.5rem;
        }

        .btn-group {
            flex-direction: column;
            gap: 0.25rem;
        }

        .btn-group .btn {
            margin-right: 0;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Header -->
    <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center mb-4">
        <div class="mb-3 mb-lg-0">
            <h1 class="page-title mb-1">
                <i class="fas fa-list-alt me-3"></i>Test Cases
            </h1>
            <p class="page-subtitle mb-0">Manage your LLM test cases and raw data</p>
        </div>
        <div class="d-flex align-items-center gap-2">
            <button class="btn btn-outline-primary" onclick="loadTestCases()">
                <i class="fas fa-refresh me-2"></i>Refresh
            </button>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createTestCaseModal">
                <i class="fas fa-plus me-2"></i>Create Test Case
            </button>
        </div>
    </div>

    <div id="agentWarning" class="alert alert-warning d-none" role="alert">
        <i class="fas fa-circle-exclamation me-2"></i>
        <span>No active agents found. Create an agent first so new test cases can be assigned correctly.</span>
        <a href="/agents" class="alert-link ms-1">Go to Agents</a>
    </div>

    <!-- Controls -->
    <div class="card mb-4">
        <div class="card-body py-3">
            <div class="d-flex flex-wrap align-items-center gap-3">
                <span class="text-muted fw-medium me-2 d-flex align-items-center">
                    <i class="fas fa-filter me-2"></i>Filters:
                </span>
                <div class="filter-search-group" data-filter="agent">
                    <input type="hidden" id="agentFilter" value="">
                    <input type="text" class="form-control form-control-sm" id="agentFilterInput"
                        placeholder="Search agents" autocomplete="off">
                    <div class="filter-search-results d-none" id="agentFilterResults"></div>
                </div>
                <div class="search-container" style="flex: 1 1 260px; max-width: 420px;">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" class="form-control" id="searchInput" placeholder="Search test case by name">
                </div>
                <button class="btn btn-outline-secondary btn-sm ms-auto" id="clearFiltersBtn">
                    <i class="fas fa-eraser me-1"></i>Clear
                </button>
            </div>
        </div>
    </div>

    <!-- Test Cases List -->
    <div class="table-container">
        <table class="table table-hover mb-0" id="testCasesTable">
            <thead>
                <tr>
                    <th style="width: 20%">Name</th>
                    <th style="width: 24%">User Message</th>
                    <th style="width: 22%">Response Example</th>
                    <th style="width: 22%">Response Expectation</th>
                    <th style="width: 12%">Created</th>
                    <th style="width: 10%" class="text-end">Actions</th>
                </tr>
            </thead>
            <tbody id="testCasesList">
                <!-- Test cases will be loaded here -->
            </tbody>
        </table>
        <div class="card-footer d-flex justify-content-between align-items-center d-none" id="testCasesPagination" style="background-color: #f8fafc; border-top: 1px solid var(--border-color);">
            <div class="text-muted small" id="testCasesPaginationStatus"></div>
            <nav aria-label="Test cases pagination">
                <ul class="pagination pagination-sm mb-0">
                    <li class="page-item" id="testCasesPrevPage">
                        <a class="page-link" href="#" id="testCasesPrevPageBtn">Previous</a>
                    </li>
                    <li class="page-item active">
                        <span class="page-link" id="testCasesPaginationCurrentPage">1</span>
                    </li>
                    <li class="page-item" id="testCasesNextPage">
                        <a class="page-link" href="#" id="testCasesNextPageBtn">Next</a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="loading-state d-none">
        <div class="loading-spinner">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <span>Loading test cases...</span>
        </div>
    </div>

    <!-- Empty State -->
    <div id="emptyState" class="empty-state d-none">
        <div class="empty-icon">
            <i class="fas fa-robot"></i>
        </div>
        <h3>No test cases found</h3>
        <p>Create your first test case to get started or import existing conversations.</p>
        <div class="d-flex justify-content-center gap-3 flex-wrap">
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createTestCaseModal">
                <i class="fas fa-plus me-2"></i>Create Test Case
            </button>
            <a class="btn btn-outline-primary" href="/agents">
                <i class="fas fa-user-astronaut me-2"></i>Manage Agents
            </a>
        </div>
    </div>
</div>

<!-- Create Test Case Modal -->
<div class="modal fade" id="createTestCaseModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create Test Case</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createTestCaseForm">
                    <div class="mb-3">
                        <label for="testCaseName" class="form-label">Name *</label>
                        <input type="text" class="form-control" id="testCaseName" required>
                    </div>
                    <div class="mb-3">
                        <label for="testCaseDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="testCaseDescription" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="createTestCaseAgentInput" class="form-label">Agent *</label>
                        <div class="filter-search-group w-100" data-filter="create-agent">
                            <input type="hidden" id="createTestCaseAgent" required>
                            <input type="text" class="form-control" id="createTestCaseAgentInput"
                                placeholder="Search agents" autocomplete="off">
                            <div class="filter-search-results d-none" id="createTestCaseAgentResults"></div>
                        </div>
                        <div class="form-text">Test cases inherit defaults and ownership from the selected agent.</div>
                    </div>
                    <div class="mb-3">
                        <label for="rawData" class="form-label">Raw Data (JSON) *</label>
                        <textarea class="form-control" id="rawData" rows="10" required
                            placeholder='Paste your logfire raw data JSON here...'></textarea>
                        <div class="form-text">Paste the complete logfire raw data JSON</div>
                    </div>
                    <div class="mb-3">
                        <label for="responseExample" class="form-label">Response Example</label>
                        <textarea class="form-control" id="responseExample" rows="4"
                            placeholder="Enter an example LLM response for similarity checks..."></textarea>
                        <div class="form-text">Stored for semantic comparisons; leave blank if unavailable.</div>
                    </div>
                    <div class="mb-3">
                        <label for="responseExpectation" class="form-label">Response Expectation</label>
                        <textarea class="form-control" id="responseExpectation" rows="4"
                            placeholder="Describe what a successful assistant reply must cover..."></textarea>
                        <div class="form-text">Use bullet points or criteria to capture the evaluation guidelines.</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createTestCase()">
                    <i class="fas fa-save me-2"></i>Create Test Case
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Test Case Modal -->
<div class="modal fade" id="editTestCaseModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Test Case</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editTestCaseForm">
                    <input type="hidden" id="editTestCaseId">
                    <div class="mb-3">
                        <label for="editTestCaseName" class="form-label">Name *</label>
                        <input type="text" class="form-control" id="editTestCaseName" required>
                    </div>
                    <div class="mb-3">
                        <label for="editTestCaseDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="editTestCaseDescription" rows="4"
                            placeholder="Enter a description for this test case..."></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="editTestCaseAgentInput" class="form-label">Agent *</label>
                        <div class="filter-search-group w-100" data-filter="edit-agent">
                            <input type="hidden" id="editTestCaseAgent" required>
                            <input type="text" class="form-control" id="editTestCaseAgentInput"
                                placeholder="Search agents" autocomplete="off">
                            <div class="filter-search-results d-none" id="editTestCaseAgentResults"></div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editResponseExample" class="form-label">Response Example</label>
                        <textarea class="form-control" id="editResponseExample" rows="4"
                            placeholder="Update the example LLM response..."></textarea>
                        <div class="form-text">Used for similarity scoring when future logs are generated.</div>
                    </div>
                    <div class="mb-3">
                        <label for="editResponseExpectation" class="form-label">Response Expectation</label>
                        <textarea class="form-control" id="editResponseExpectation" rows="4"
                            placeholder="Revise the acceptance criteria or evaluation guidelines..."></textarea>
                        <div class="form-text">Keep expectations concise so evaluators can quickly validate outputs.</div>
                    </div>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Note:</strong> Update the agent to hand off this test case to a different model
                        configuration and adjust the response example as needed. Other parsed properties (system prompt,
                        user message, etc.) remain read-only here.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateTestCase()">
                    <i class="fas fa-save me-2"></i>Update Test Case
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Re-import Test Case Modal -->
<div class="modal fade" id="reimportTestCaseModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Re-import Raw Data</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="reimportAlertContainer"></div>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Warning:</strong> Re-importing will overwrite all parsed data (system prompt, user
                    message, model settings, etc.) with the new raw data. Only the test case name and description
                    will be preserved.
                </div>
                <form id="reimportTestCaseForm">
                    <input type="hidden" id="reimportTestCaseId">
                    <div class="mb-3">
                        <label for="reimportRawData" class="form-label">New Raw Data (JSON) *</label>
                        <textarea class="form-control" id="reimportRawData" rows="10" required
                            placeholder='Paste your new logfire raw data JSON here...'></textarea>
                        <div class="form-text">Paste the complete logfire raw data JSON to replace the existing data
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" onclick="confirmReimportTestCase()">
                    <i class="fas fa-upload me-2"></i>Re-import Data
                </button>
            </div>
        </div>
    </div>
</div>

<!-- View Test Case Modal -->
<div class="modal fade" id="viewTestCaseModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Test Case Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="testCaseDetails">
                    <!-- Test case details will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" onclick="executeFromView()">
                    <i class="fas fa-play me-2"></i>Execute Test
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="/static/js/hover-tooltips.js?v={{ static_asset_version }}"></script>
<script src="/static/js/test-cases.js?v={{ static_asset_version }}"></script>
{% endblock %}
