{% extends "base.html" %}

{% block page_title %}Test Log Details - LLM Replay System{% endblock %}

{% block extra_css %}
<style>
    /* Page Header */
    .page-header {
        margin-bottom: 2rem;
    }

    .page-title {
        font-size: 2rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 0.5rem;
    }

    .page-subtitle {
        color: var(--text-secondary);
        font-size: 1rem;
    }

    /* Action buttons in header */
    .page-header #actionButtons {
        margin-top: 0.5rem;
    }

    /* Card Styles */
    .card {
        background: var(--card-background);
        border: 1px solid var(--border-color);
        border-radius: 0.75rem;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        transition: all 0.2s ease;
    }

    .card:hover {
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .card-header {
        background-color: #f8fafc;
        border-bottom: 1px solid var(--border-color);
        font-weight: 600;
        color: var(--text-primary);
        padding: 1rem 1.5rem;
        border-radius: 0.75rem 0.75rem 0 0 !important;
    }

    .card-body {
        padding: 1.5rem;
    }

    /* Button Styles */
    .btn-primary {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
        font-weight: 500;
        padding: 0.625rem 1.25rem;
        border-radius: 0.5rem;
        transition: all 0.2s ease;
    }

    .btn-primary:hover {
        background-color: var(--primary-hover);
        border-color: var(--primary-hover);
        transform: translateY(-1px);
    }

    .btn-outline-secondary {
        color: var(--text-secondary);
        border-color: var(--border-color);
        font-weight: 500;
        border-radius: 0.5rem;
        transition: all 0.2s ease;
    }

    .btn-outline-secondary:hover {
        background-color: var(--text-secondary);
        border-color: var(--text-secondary);
        transform: translateY(-1px);
    }

    .btn-success {
        background-color: var(--success-color);
        border-color: var(--success-color);
        font-weight: 500;
        border-radius: 0.5rem;
    }

    .btn-outline-danger {
        color: var(--danger-color);
        border-color: var(--danger-color);
        font-weight: 500;
        border-radius: 0.5rem;
    }

    /* Back Button */
    .back-button {
        margin-bottom: 1.5rem;
    }

    /* Status Styles */
    .status-success {
        color: var(--success-color);
        font-weight: 600;
    }

    .status-failed {
        color: var(--danger-color);
        font-weight: 600;
    }

    /* Table Styles */
    .info-table {
        margin-bottom: 0;
    }

    .info-table td {
        padding: 0.75rem 1rem;
        border-bottom: 1px solid #f1f5f9;
        vertical-align: middle;
    }

    .info-table td:first-child {
        font-weight: 600;
        color: var(--text-secondary);
        width: 150px;
        background-color: #f8fafc;
    }

    .info-table tr:last-child td {
        border-bottom: none;
    }

    /* Code Block Styles */
    .code-block {
        background-color: #f1f5f9;
        border: 1px solid var(--border-color);
        border-radius: 0.5rem;
        padding: 1rem;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 0.875rem;
        line-height: 1.5;
        max-height: 400px;
        overflow-y: auto;
        color: var(--text-primary);
        white-space: pre-wrap;
        word-wrap: break-word;
    }

    /* Loading State */
    .loading-state {
        text-align: center;
        padding: 3rem 2rem;
    }

    .loading-spinner {
        display: inline-flex;
        align-items: center;
        gap: 0.75rem;
        color: var(--primary-color);
    }

    .loading-spinner .spinner-border {
        width: 1.25rem;
        height: 1.25rem;
    }

    /* Error Message */
    .error-message {
        background-color: #fef2f2;
        border: 1px solid #fecaca;
        color: var(--danger-color);
        padding: 1rem;
        border-radius: 0.5rem;
        margin: 1rem 0;
    }

    /* Accordion Styles */
    .accordion-item {
        border: 1px solid var(--border-color);
        border-radius: 0.5rem !important;
        margin-bottom: 0.5rem;
    }

    .accordion-button {
        background-color: var(--card-background);
        color: var(--text-primary);
        font-weight: 500;
        border-radius: 0.5rem !important;
    }

    .accordion-button:not(.collapsed) {
        background-color: #f8fafc;
        color: var(--primary-color);
        box-shadow: none;
    }

    .accordion-button:focus {
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .accordion-body {
        padding: 1rem;
    }

    /* Alert Styles */
    .alert-danger {
        background-color: #fef2f2;
        border-color: #fecaca;
        color: var(--danger-color);
        border-radius: 0.5rem;
    }

    /* Responsive Improvements */
    @media (max-width: 768px) {
        .page-title {
            font-size: 1.5rem;
        }

        .card-body {
            padding: 1rem;
        }

        .info-table td:first-child {
            width: 120px;
            font-size: 0.875rem;
        }

        .btn-group {
            flex-direction: column;
            gap: 0.5rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Header with Action Buttons -->
    <div class="page-header d-flex justify-content-between align-items-start">
        <div>
            <h1 class="page-title">
                <i class="fas fa-file-alt me-3"></i>Test Log Details
            </h1>
            <p class="page-subtitle">Detailed view of test execution log</p>
        </div>
        <div id="actionButtons" class="d-none">
            <div class="d-flex gap-2">
                <button type="button" class="btn btn-success" onclick="reExecuteTest()">
                    <i class="fas fa-redo me-2"></i>Re-execute Test
                </button>
                <button type="button" class="btn btn-outline-danger" onclick="deleteLog()">
                    <i class="fas fa-trash me-2"></i>Delete Log
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="loading-state">
        <div class="loading-spinner">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <span>Loading test log details...</span>
        </div>
    </div>

    <!-- Error Message -->
    <div id="errorMessage" class="error-message d-none">
        <i class="fas fa-exclamation-triangle me-2"></i>
        <span id="errorText"></span>
    </div>

    <!-- Log Details Content -->
    <div id="logDetailsContent" class="d-none">
        <!-- Content will be loaded here -->
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Get log ID from URL
    const logId = '{{ log_id }}';
    let currentLog = null;
    let testCasesData = [];
    let agentSummary = null;
    let regressionSummary = null;
    const agentCache = new Map();
    const regressionCache = new Map();

    // Initialize page
    document.addEventListener('DOMContentLoaded', async function () {
        await loadTestCases();
        await loadLogDetails();
    });

    async function loadTestCases() {
        try {
            const response = await fetch('/v1/api/test-cases/');
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            testCasesData = await response.json();
        } catch (error) {
            console.error('Error loading test cases:', error);
        }
    }

    async function loadLogDetails() {
        try {
            const response = await fetch(`/v1/api/test-logs/${logId}`);
            if (!response.ok) {
                if (response.status === 404) {
                    throw new Error('Test log not found');
                }
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            currentLog = await response.json();

            await loadAgentSummary(currentLog.agent_id);
            if (currentLog.regression_test_id) {
                await loadRegressionSummary(currentLog.regression_test_id);
            } else {
                regressionSummary = null;
            }

            displayLogDetails(currentLog);

        } catch (error) {
            console.error('Error loading log details:', error);
            showError(error.message);
        } finally {
            hideLoading();
        }
    }

    function displayLogDetails(log) {
        const testCase = findTestCaseById(log.test_case_id);
        const responseTime = formatResponseTime(log.response_time_ms);

        const passBadge = formatPassBadge(log);

        const detailsHtml = `
                    <div class="row">
                        <!-- Left Column -->
                        <div class="col-md-6">
                            <!-- Execution Information -->
                            <div class="card mb-4">
                                <div class="card-header">
                                    <i class="fas fa-info-circle me-2"></i>Execution Information
                                </div>
                                <div class="card-body p-0">
                                    <table class="table info-table mb-0">
                                        <tr>
                                            <td>Log ID:</td>
                                            <td><code>${escapeHtml(log.id)}</code></td>
                                        </tr>
                                        <tr>
                                            <td>Status:</td>
                                            <td>
                                                <span class="status-${log.status}">
                                                    <i class="fas fa-${log.status === 'success' ? 'check-circle' : 'times-circle'} me-1"></i>
                                                    ${log.status.toUpperCase()}
                                                </span>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>Model:</td>
                                            <td>${escapeHtml(log.model_name)}</td>
                                        </tr>
                                        <tr>
                                            <td>Agent:</td>
                                            <td>${formatAgentSummary(log.agent_id)}</td>
                                        </tr>
                                        <tr>
                                            <td>Regression Test:</td>
                                            <td>${formatRegressionSummary(log.regression_test_id)}</td>
                                        </tr>
                                        <tr>
                                            <td>Response Time:</td>
                                            <td><strong>${responseTime}</strong></td>
                                        </tr>
                                        <tr>
                                            <td>Evaluation Result:</td>
                                            <td>${passBadge}</td>
                                        </tr>
                                        <tr>
                                            <td>Evaluation Feedback:</td>
                                            <td>${formatEvaluationFeedback(log.evaluation_feedback)}</td>
                                        </tr>
                                        <tr>
                                            <td>Evaluation Model:</td>
                                            <td>${escapeHtml(log.evaluation_model_name || '—')}</td>
                                        </tr>
                                        <tr>
                                            <td>Expectation Snapshot:</td>
                                            <td>${formatExpectationSnapshot(log.response_expectation_snapshot)}</td>
                                        </tr>
                                        <tr>
                                            <td>Test Case:</td>
                                            <td>
                                                <a href="/test-cases/${log.test_case_id}" class="text-decoration-none" target="_blank">
                                                    ${escapeHtml(testCase?.name || log.test_case_id)}
                                                    <i class="fas fa-external-link-alt ms-1" style="font-size: 0.8em;"></i>
                                                </a>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>Executed At:</td>
                                            <td>${escapeHtml(formatDate(log.created_at))}</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>



                            <!-- System Prompt -->
                            <div class="card mb-4">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <span>
                                        <i class="fas fa-terminal me-2"></i>System Prompt
                                    </span>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="copyToClipboard('systemPromptContent', this)" title="Copy System Prompt">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                                <div class="card-body">
                                    <div class="code-block" id="systemPromptContent">${escapeHtml(log.system_prompt)}</div>
                                </div>
                            </div>

                            <!-- Model Settings -->
                            <div class="card mb-4">
                                <div class="card-header">
                                    <div class="d-flex align-items-center">
                                        <button class="btn btn-link text-decoration-none p-0 text-muted" type="button"
                                            data-bs-toggle="collapse" data-bs-target="#modelSettingsCollapse"
                                            aria-expanded="false" aria-controls="modelSettingsCollapse">
                                            <i class="fas fa-chevron-right me-1" id="modelSettingsChevron"
                                                style="font-size: 0.8em;"></i>
                                            <span style="font-size: 0.9em;">Model Settings</span>
                                        </button>
                                    </div>
                                </div>
                                <div class="collapse" id="modelSettingsCollapse">
                                    <div class="card-body">
                                        ${log.model_settings !== null && log.model_settings !== undefined ?
                `<pre class="bg-light p-3 rounded mb-0"><code>${escapeHtml(JSON.stringify(log.model_settings, null, 2))}</code></pre>` :
                '<p class="text-muted mb-0">No model settings specified</p>'
            }
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Right Column -->
                        <div class="col-md-6">
                            <!-- User Message -->
                            <div class="card mb-4">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <span>
                                        <i class="fas fa-comment me-2"></i>User Message
                                    </span>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="copyToClipboard('userMessageContent', this)" title="Copy User Message">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                                <div class="card-body">
                                    <div class="code-block" id="userMessageContent">${escapeHtml(log.user_message)}</div>
                                </div>
                            </div>

                            <!-- LLM Response -->
                            ${log.llm_response ? `
                                <div class="card mb-4">
                                    <div class="card-header">
                                        <i class="fas fa-robot me-2"></i>LLM Response
                                    </div>
                                    <div class="card-body">
                                        <div class="code-block">${escapeHtml(log.llm_response)}</div>
                                    </div>
                                </div>
                            ` : `
                                <div class="card mb-4">
                                    <div class="card-header">
                                        <i class="fas fa-robot me-2"></i>LLM Response
                                    </div>
                                    <div class="card-body">
                                        <p class="text-muted mb-0">No LLM response available</p>
                                    </div>
                                </div>
                            `}

                            <!-- Response Example -->
                            ${log.response_example ? `
                                <div class="card mb-4">
                                    <div class="card-header">
                                        <div class="d-flex align-items-center">
                                            <button class="btn btn-link text-decoration-none p-0 text-muted" type="button"
                                                data-bs-toggle="collapse" data-bs-target="#responseExampleCollapse"
                                                aria-expanded="false" aria-controls="responseExampleCollapse">
                                                <i class="fas fa-chevron-right me-1" id="responseExampleChevron"
                                                    style="font-size: 0.8em;"></i>
                                                <span style="font-size: 0.9em;">Response Example</span>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="collapse" id="responseExampleCollapse">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <small class="text-muted">Expected response example for comparison</small>
                                                <button class="btn btn-sm btn-outline-secondary" onclick="copyToClipboard('responseExampleContent', this)" title="Copy Response Example">
                                                    <i class="fas fa-copy"></i>
                                                </button>
                                            </div>
                                            <div class="code-block" id="responseExampleContent">${escapeHtml(log.response_example)}</div>
                                        </div>
                                    </div>
                                </div>
                            ` : `
                                <div class="card mb-4">
                                    <div class="card-header">
                                        <div class="d-flex align-items-center">
                                            <button class="btn btn-link text-decoration-none p-0 text-muted" type="button" disabled>
                                                <i class="fas fa-chevron-right me-1" style="font-size: 0.8em;"></i>
                                                <span style="font-size: 0.9em;">Response Example</span>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <p class="text-muted mb-0">No response example available</p>
                                    </div>
                                </div>
                            `}

                            <!-- Tools Configuration -->
                            ${log.tools && log.tools.length > 0 ? `
                                <div class="card mb-4">
                                    <div class="card-header">
                                        <i class="fas fa-wrench me-2"></i>Tools Configuration
                                    </div>
                                    <div class="card-body">
                                        <div class="accordion" id="logToolsAccordion">
                                            ${log.tools.map((tool, index) => `
                                                <div class="accordion-item">
                                                    <h2 class="accordion-header" id="logHeading${index}">
                                                        <button class="accordion-button collapsed" type="button"
                                                                data-bs-toggle="collapse" data-bs-target="#logCollapse${index}"
                                                                aria-expanded="false" aria-controls="logCollapse${index}">
                                                            <i class="fas fa-wrench me-2"></i>
                                                            <strong>${escapeHtml(tool.function?.name || 'Unknown Tool')}</strong>
                                                        </button>
                                                    </h2>
                                                    <div id="logCollapse${index}" class="accordion-collapse collapse"
                                                         aria-labelledby="logHeading${index}" data-bs-parent="#logToolsAccordion">
                                                        <div class="accordion-body">
                                                            <div class="code-block" style="font-size: 0.85em;">${escapeHtml(JSON.stringify(tool, null, 2))}</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>
                            ` : `
                                <div class="card mb-4">
                                    <div class="card-header">
                                        <i class="fas fa-wrench me-2"></i>Tools
                                    </div>
                                    <div class="card-body">
                                        <p class="text-muted mb-0">No tools used</p>
                                    </div>
                                </div>
                            `}
                        </div>
                    </div>

                    ${log.error_message ? `
                        <div class="row">
                            <div class="col-12 mb-4">
                                <div class="card">
                                    <div class="card-header text-danger">
                                        <i class="fas fa-exclamation-triangle me-2"></i>Error Message
                                    </div>
                                    <div class="card-body">
                                        <div class="alert alert-danger mb-0">
                                            ${escapeHtml(log.error_message)}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                `;

        const detailsContainer = document.getElementById('logDetailsContent');
        detailsContainer.innerHTML = detailsHtml;
        applyTooltipContent(detailsContainer);
        if (window.HoverTooltip) {
            window.HoverTooltip.attach(detailsContainer);
        }
        initializeTooltips(detailsContainer);
        detailsContainer.classList.remove('d-none');
        document.getElementById('actionButtons').classList.remove('d-none');

        // Setup Model Settings collapse handlers
        setupModelSettingsCollapse(log);
        
        // Setup Response Example collapse handlers
        setupResponseExampleCollapse(log);
    }

    async function loadAgentSummary(agentId) {
        if (!agentId) {
            agentSummary = null;
            return;
        }

        if (agentCache.has(agentId)) {
            agentSummary = agentCache.get(agentId);
            return;
        }

        try {
            const response = await fetch(`/v1/api/agents/${agentId}`);
            if (!response.ok) {
                if (response.status === 404) {
                    agentSummary = null;
                    return;
                }
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            agentCache.set(agentId, data);
            agentSummary = data;
        } catch (error) {
            console.error('Error loading agent summary:', error);
            agentSummary = null;
        }
    }

    async function loadRegressionSummary(regressionId) {
        if (!regressionId) {
            regressionSummary = null;
            return;
        }

        if (regressionCache.has(regressionId)) {
            regressionSummary = regressionCache.get(regressionId);
            return;
        }

        try {
            const response = await fetch(`/v1/api/regression-tests/${regressionId}`);
            if (!response.ok) {
                if (response.status === 404) {
                    regressionSummary = null;
                    return;
                }
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            regressionCache.set(regressionId, data);
            regressionSummary = data;
        } catch (error) {
            console.error('Error loading regression summary:', error);
            regressionSummary = null;
        }
    }

    function setupModelSettingsCollapse(log) {
        const modelSettingsCollapse = document.getElementById('modelSettingsCollapse');
        const modelSettingsChevron = document.getElementById('modelSettingsChevron');

        if (!modelSettingsCollapse || !modelSettingsChevron) return;

        // Handle chevron icon rotation
        modelSettingsCollapse.addEventListener('show.bs.collapse', function () {
            modelSettingsChevron.classList.remove('fa-chevron-right');
            modelSettingsChevron.classList.add('fa-chevron-down');
        });

        modelSettingsCollapse.addEventListener('hide.bs.collapse', function () {
            modelSettingsChevron.classList.remove('fa-chevron-down');
            modelSettingsChevron.classList.add('fa-chevron-right');
        });

        // Auto-expand if there are model settings
        if (log.model_settings !== null && log.model_settings !== undefined) {
            const bsCollapse = new bootstrap.Collapse(modelSettingsCollapse, { show: true });
        }
    }

    function setupResponseExampleCollapse(log) {
        const responseExampleCollapse = document.getElementById('responseExampleCollapse');
        const responseExampleChevron = document.getElementById('responseExampleChevron');

        if (!responseExampleCollapse || !responseExampleChevron) return;

        // Handle chevron icon rotation
        responseExampleCollapse.addEventListener('show.bs.collapse', function () {
            responseExampleChevron.classList.remove('fa-chevron-right');
            responseExampleChevron.classList.add('fa-chevron-down');
        });

        responseExampleCollapse.addEventListener('hide.bs.collapse', function () {
            responseExampleChevron.classList.remove('fa-chevron-down');
            responseExampleChevron.classList.add('fa-chevron-right');
        });

        // Response example section remains collapsed by default
        // No auto-expand behavior needed since it should be collapsed by default
    }

    // Helper functions
    function findTestCaseById(testCaseId) {
        return testCasesData.find(tc => tc.id === testCaseId);
    }

    function formatAgentSummary(agentId) {
        if (!agentId) {
            return '<span class="text-muted">Unknown agent</span>';
        }

        const summary = agentCache.get(agentId) || agentSummary;
        if (!summary) {
            return `<span class="badge bg-secondary">${escapeHtml(agentId)}</span>`;
        }

        const agentName = summary.name ? escapeHtml(summary.name) : 'Unnamed agent';
        return `<a href="/agents/${escapeHtml(agentId)}" class="badge bg-primary text-decoration-none" target="_blank">${agentName}</a>`;
    }

    function formatRegressionTimestamp(createdAt) {
        if (!createdAt) {
            return 'Unknown';
        }
        const date = new Date(createdAt);
        if (Number.isNaN(date.getTime())) {
            return 'Unknown';
        }

        const pad = (value) => String(value).padStart(2, '0');
        const yyyy = date.getFullYear();
        const MM = pad(date.getMonth() + 1);
        const dd = pad(date.getDate());
        const hh = pad(date.getHours());
        const mm = pad(date.getMinutes());
        const ss = pad(date.getSeconds());

        return `${yyyy}${MM}${dd}${hh}${mm}${ss}`;
    }

    function formatRegressionSummary(regressionId) {
        if (!regressionId) {
            return '<span class="text-muted">Ad-hoc execution</span>';
        }

        const summary = regressionCache.get(regressionId) || regressionSummary;
        const encodedRegressionId = encodeURIComponent(regressionId);

        if (!summary) {
            return `<a href="/regression-tests/${encodedRegressionId}" class="text-decoration-none" target="_blank">${escapeHtml(regressionId)}</a>`;
        }

        const timestamp = formatRegressionTimestamp(summary.created_at);
        const display = timestamp || regressionId;
        return `<a href="/regression-tests/${encodedRegressionId}" class="text-decoration-none" target="_blank">${escapeHtml(display)}</a>`;
    }

    function formatResponseTime(value) {
        if (value === null || value === undefined) {
            return '—';
        }
        return `${value}ms`;
    }

    function resolveEvaluationDisplay(target) {
        const status = target && typeof target.is_passed !== 'undefined' ? target.is_passed : null;
        if (status === true) {
            return { label: 'Passed', badgeClass: 'bg-success', icon: 'check' };
        }
        if (status === false) {
            return { label: 'Failed', badgeClass: 'bg-danger', icon: 'times' };
        }
        return { label: 'Unknown', badgeClass: 'bg-secondary', icon: 'question' };
    }

    function buildEvaluationTooltip(log) {
        if (!log) {
            return 'Evaluation details unavailable.';
        }

        const lines = [];
        const feedback = (log.evaluation_feedback || '').trim();
        if (feedback) {
            lines.push(feedback);
        }

        if (log.response_expectation_snapshot) {
            lines.push(`Expectation snapshot:\n${log.response_expectation_snapshot.trim()}`);
        }

        if (log.evaluation_model_name) {
            lines.push(`Model: ${log.evaluation_model_name}`);
        }

        const metadata = log.evaluation_metadata || {};
        if (Array.isArray(metadata.missing_criteria) && metadata.missing_criteria.length > 0) {
            lines.push(`Missing criteria:\n- ${metadata.missing_criteria.join('\n- ')}`);
        }
        if (Array.isArray(metadata.satisfied_criteria) && metadata.satisfied_criteria.length > 0) {
            lines.push(`Satisfied criteria:\n- ${metadata.satisfied_criteria.join('\n- ')}`);
        }

        if (lines.length === 0) {
            const display = resolveEvaluationDisplay(log);
            if (display.label === 'Passed') {
                lines.push('Marked as passed.');
            } else if (display.label === 'Failed') {
                lines.push('Marked as failed.');
            } else {
                lines.push('Evaluation skipped or not applicable.');
            }
        }

        return lines.join('\n\n');
    }

    function formatPassBadge(log) {
        const display = resolveEvaluationDisplay(log);
        const tooltipContent = encodeTooltipPayload(buildEvaluationTooltip(log));
        const fallback = encodeTooltipPayload(display.label);

        return `
            <span class="badge ${display.badgeClass} log-preview"
                  data-bs-toggle="tooltip" data-bs-placement="top"
                  data-bs-custom-class="log-tooltip" data-bs-html="true"
                  data-tooltip-content="${tooltipContent}" data-tooltip-fallback="${fallback}">
                <i class="fas fa-${display.icon} me-1"></i>${display.label}
            </span>
        `;
    }

    function formatEvaluationFeedback(feedback) {
        if (!feedback) {
            return '<span class="text-muted">—</span>';
        }
        const trimmed = feedback.trim();
        if (!trimmed) {
            return '<span class="text-muted">—</span>';
        }
        return `<div class="text-break" style="white-space: pre-wrap;">${escapeHtml(trimmed)}</div>`;
    }

    function formatExpectationSnapshot(snapshot) {
        if (!snapshot) {
            return '<span class="text-muted">—</span>';
        }
        const trimmed = snapshot.trim();
        if (!trimmed) {
            return '<span class="text-muted">—</span>';
        }
        return `<div class="text-break" style="white-space: pre-wrap;">${escapeHtml(trimmed)}</div>`;
    }

    function hideLoading() {
        document.getElementById('loadingSpinner').style.display = 'none';
    }

    function showError(message) {
        document.getElementById('errorText').textContent = message;
        document.getElementById('errorMessage').classList.remove('d-none');
    }

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
    }

    function truncateText(text, maxLength) {
        if (!text) return '';
        if (text.length <= maxLength) return escapeHtml(text);
        return escapeHtml(text.substring(0, maxLength)) + '...';
    }

    function formatTooltipContent(text, fallback = '—') {
        if (!text) {
            return `<div class='tooltip-log-content'>${escapeHtml(fallback)}</div>`;
        }
        const normalized = text.trim();
        if (!normalized) {
            return `<div class='tooltip-log-content'>${escapeHtml(fallback)}</div>`;
        }
        const htmlContent = escapeHtml(text).replace(/\n/g, '<br>');
        return `<div class='tooltip-log-content'>${htmlContent}</div>`;
    }

    function encodeTooltipPayload(text) {
        if (!text) {
            return '';
        }
        return encodeURIComponent(text);
    }

    function decodeTooltipPayload(value) {
        if (!value) {
            return '';
        }
        try {
            return decodeURIComponent(value);
        } catch (error) {
            console.error('Failed to decode tooltip payload', error);
            return value;
        }
    }

    function applyTooltipContent(container) {
        if (!container) {
            return;
        }
        const tooltipTargets = container.querySelectorAll('[data-tooltip-content]');
        tooltipTargets.forEach((element) => {
            const encodedContent = element.getAttribute('data-tooltip-content') || '';
            const encodedFallback = element.getAttribute('data-tooltip-fallback') || '';
            const content = decodeTooltipPayload(encodedContent);
            const fallback = decodeTooltipPayload(encodedFallback);
            const tooltipHtml = formatTooltipContent(content, fallback || undefined);
            element.setAttribute('data-bs-title', tooltipHtml);
            element.setAttribute('data-hover-html', tooltipHtml);
        });
    }

    function initializeTooltips(container) {
        if (typeof bootstrap === 'undefined' || !bootstrap.Tooltip) {
            return;
        }
        const scope = container || document;
        const elements = scope.querySelectorAll
            ? scope.querySelectorAll('[data-bs-toggle="tooltip"]:not(.log-preview)')
            : document.querySelectorAll('[data-bs-toggle="tooltip"]:not(.log-preview)');
        elements.forEach((element) => {
            bootstrap.Tooltip.getOrCreateInstance(element);
        });
    }

    async function copyToClipboard(elementId, buttonElement) {
        try {
            const element = document.getElementById(elementId);
            if (!element) {
                console.error('Element not found:', elementId);
                return;
            }

            // Get the text content (without HTML tags)
            const textToCopy = element.textContent || element.innerText;

            // Use the modern clipboard API
            if (navigator.clipboard && window.isSecureContext) {
                await navigator.clipboard.writeText(textToCopy);
            } else {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = textToCopy;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                textArea.style.top = '-999999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                document.execCommand('copy');
                textArea.remove();
            }

            // Visual feedback
            const originalIcon = buttonElement.innerHTML;
            buttonElement.innerHTML = '<i class="fas fa-check text-success"></i>';
            buttonElement.disabled = true;

            setTimeout(() => {
                buttonElement.innerHTML = originalIcon;
                buttonElement.disabled = false;
            }, 1500);

        } catch (err) {
            console.error('Failed to copy text: ', err);

            // Show error feedback
            const originalIcon = buttonElement.innerHTML;
            buttonElement.innerHTML = '<i class="fas fa-times text-danger"></i>';

            setTimeout(() => {
                buttonElement.innerHTML = originalIcon;
            }, 1500);
        }
    }

    function reExecuteTest() {
        if (currentLog) {
            window.location.href = `/test-execution?logId=${currentLog.id}`;
        }
    }

    async function deleteLog() {
        if (!confirm('Are you sure you want to delete this test log? This action cannot be undone.')) {
            return;
        }

        try {
            const response = await fetch(`/v1/api/test-logs/${logId}`, {
                method: 'DELETE'
            });

            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

            alert('Test log deleted successfully!');
            window.location.href = '/test-logs';

        } catch (error) {
            console.error('Error deleting test log:', error);
            alert('Error deleting test log: ' + error.message);
        }
    }
</script>
{% endblock %}
